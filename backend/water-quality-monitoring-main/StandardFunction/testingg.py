import pandas as pd


data ={'DO': {'DO': {'2018-05-30': 5.4, '2018-12-14': 6.14, '2018-12-16': 5.69, '2018-12-19': 5.55, '2018-12-21': 5.47, '2018-12-26': 5.4, '2018-12-29': 5.82, '2018-12-31': 5.49, '2019-01-03': 5.69, '2019-01-05': 5.55, '2019-01-08': 5.73, '2019-01-10': 6.25, '2019-01-13': 5.77, '2019-01-15': 5.94, '2019-01-20': 5.8, '2019-01-23': 5.51, '2019-01-25': 5.48, '2019-01-28': 5.82, '2019-01-30': 5.56, '2019-02-07': 5.73, '2019-02-09': 5.66, '2019-02-12': 6.05, '2019-02-14': 6.2, '2019-02-17': 5.64, '2019-02-19': 5.6, '2019-02-22': 6.1, '2019-02-24': 5.36, '2019-02-27': 5.79, '2019-03-01': 5.55, '2019-03-06': 5.55, '2019-03-09': 5.65, '2019-03-11': 5.63, '2019-03-14': 8.3, '2019-03-16': 5.78, '2019-03-19': 5.67, '2019-03-21': 5.56, '2019-03-24': 6.07, '2019-03-26': 5.78, '2019-03-29': 5.91, '2019-03-31': 6.11, '2019-04-03': 6.03, '2019-04-05': 6.22, '2019-04-08': 6.54, '2019-04-10': 5.73, '2019-04-13': 6.31, '2019-04-18': 6.89, '2019-04-20': 5.52, '2019-04-23': 6.99, '2019-04-25': 6.13, '2019-04-30': 6.04, '2019-05-03': 6.56, '2019-05-05': 5.86, '2019-05-08': 6.55, '2019-05-10': 5.78, '2019-05-13': 7.02, '2019-05-15': 5.74, '2019-05-18': 6.76, '2019-05-20': 5.7, '2019-05-23': 6.64, '2019-05-25': 5.83, '2019-05-28': 6.53, '2019-05-30': 6.36, '2019-06-02': 6.34, '2019-06-09': 6.34, '2019-10-05': 7.18, '2019-10-07': 6.03, '2019-10-10': 6.99, '2019-10-12': 6.03, '2019-10-15': 5.89, '2019-10-17': 6.0, '2019-11-04': 6.07, '2019-11-06': 5.74, '2019-11-11': 5.81, '2019-11-14': 5.86, '2019-11-16': 5.69, '2019-11-21': 5.94, '2019-11-24': 5.88, '2019-11-26': 5.6, '2019-11-29': 6.43, '2019-12-06': 5.66, '2019-12-09': 5.58, '2019-12-11': 5.76, '2019-12-14': 5.6, '2019-12-19': 5.89, '2019-12-26': 5.54, '2019-12-31': 5.87, '2020-01-03': 5.78, '2020-01-05': 5.69, '2020-01-10': 6.86, '2020-01-18': 5.6, '2020-01-20': 5.65, '2020-01-23': 5.97, '2020-01-25': 7.58, '2020-01-28': 5.69, '2020-01-30': 5.52, '2020-02-02': 5.87, '2020-02-04': 5.89, '2020-02-07': 5.66, '2020-02-09': 6.06, '2020-02-14': 5.94, '2020-02-17': 5.9, '2020-02-19': 5.71, '2020-02-22': 5.89, '2020-02-24': 5.65, '2020-02-27': 5.73, '2020-02-29': 6.14, '2020-03-03': 5.62, '2020-03-05': 5.77, '2020-03-08': 5.69, '2020-03-10': 6.0, '2020-03-15': 5.63, '2020-03-18': 5.84, '2020-03-20': 5.53, '2020-03-23': 5.7, '2020-03-25': 8.69, '2020-03-28': 6.06, '2020-03-30': 6.13, '2020-04-02': 6.12, '2020-04-04': 5.61, '2020-04-07': 6.35, '2020-04-09': 5.81, '2020-04-12': 6.05, '2020-04-14': 5.92, '2020-04-17': 5.99, '2020-04-22': 6.34, '2020-04-24': 5.6, '2020-04-27': 6.98, '2020-04-29': 5.82, '2020-05-02': 6.08, '2020-05-04': 5.53, '2020-05-07': 6.94, '2020-05-09': 5.62, '2020-05-12': 7.5, '2020-05-14': 5.83, '2020-05-22': 6.46, '2020-05-24': 5.83, '2020-05-27': 6.35, '2020-05-29': 5.62, '2020-09-04': 6.33, '2020-10-06': 5.74, '2020-10-24': 5.76, '2020-10-26': 5.84, '2020-10-29': 5.6, '2020-10-31': 5.71, '2020-11-03': 5.92, '2020-11-05': 5.97, '2020-11-08': 5.8, '2020-11-10': 5.79, '2020-11-13': 5.8, '2020-11-15': 5.62, '2020-11-23': 6.0, '2020-11-25': 6.36, '2020-11-28': 5.5, '2020-11-30': 5.49, '2020-12-03': 5.54, '2020-12-05': 5.52, '2020-12-15': 5.81, '2020-12-18': 5.98, '2020-12-20': 5.68, '2020-12-23': 5.74, '2020-12-25': 5.73, '2020-12-28': 5.51, '2020-12-30': 6.17, '2021-01-02': 6.44, '2021-01-12': 5.76, '2021-01-17': 5.86, '2021-01-19': 5.98, '2021-01-22': 5.68, '2021-01-24': 5.52, '2021-01-27': 5.85, '2021-01-29': 5.73, '2021-02-01': 6.23, '2021-02-03': 5.94, '2021-02-06': 5.76, '2021-02-08': 5.58, '2021-02-13': 6.25, '2021-02-16': 6.29, '2021-02-18': 6.88, '2021-02-21': 5.97, '2021-02-23': 6.02, '2021-02-26': 5.88, '2021-02-28': 5.51, '2021-03-03': 5.7, '2021-03-05': 5.61, '2021-03-08': 5.92, '2021-03-10': 6.16, '2021-03-13': 5.93, '2021-03-15': 6.27, '2021-03-18': 6.45, '2021-03-20': 6.47, '2021-03-23': 6.02, '2021-03-25': 5.86, '2021-03-28': 6.03, '2021-03-30': 5.64, '2021-04-02': 6.81, '2021-04-04': 5.77, '2021-04-07': 6.04, '2021-04-09': 6.13, '2021-04-12': 6.12, '2021-04-17': 6.32, '2021-04-19': 5.75, '2021-04-24': 5.62, '2021-04-27': 6.43, '2021-04-29': 6.18, '2021-05-04': 5.69, '2021-05-07': 5.84, '2021-05-09': 6.38, '2021-05-12': 7.93, '2021-05-22': 7.03, '2021-05-29': 6.2, '2021-06-03': 5.94, '2021-07-06': 6.29, '2021-10-04': 5.87, '2021-10-11': 5.92, '2021-10-14': 9.82, '2021-10-16': 5.56, '2021-10-19': 5.74, '2021-10-21': 5.77, '2021-10-24': 13.78, '2021-10-26': 5.76, '2021-10-29': 5.72, '2021-10-31': 5.7, '2021-11-03': 5.74, '2021-11-08': 5.6, '2021-11-10': 5.99, '2021-11-23': 7.74, '2021-11-25': 5.91, '2021-11-28': 5.65, '2021-12-03': 7.23, '2021-12-05': 5.53, '2021-12-08': 7.0, '2021-12-10': 6.19, '2021-12-13': 6.52, '2021-12-18': 6.21, '2021-12-20': 5.8, '2021-12-23': 5.87, '2021-12-25': 5.4, '2021-12-28': 7.51, '2022-01-02': 6.39, '2022-01-07': 6.43, '2022-01-09': 5.42, '2022-01-12': 6.88, '2022-01-14': 7.27, '2022-01-17': 5.97, '2022-01-19': 5.54, '2022-01-24': 5.51, '2022-01-27': 5.74, '2022-01-29': 5.5, '2022-02-01': 5.46, '2022-02-03': 5.37, '2022-02-06': 5.66, '2022-02-08': 5.35, '2022-02-11': 5.65, '2022-02-13': 5.5, '2022-02-16': 6.01, '2022-02-18': 5.33, '2022-02-21': 5.54, '2022-02-23': 5.56, '2022-02-26': 6.18, '2022-02-28': 5.65, '2022-03-03': 6.14, '2022-03-05': 5.94, '2022-03-10': 5.57, '2022-03-13': 5.74, '2022-03-15': 5.67, '2022-03-18': 5.93, '2022-03-28': 6.06, '2022-03-30': 5.51, '2022-04-02': 5.89, '2022-04-04': 5.39, '2022-04-07': 6.22, '2022-04-09': 5.89, '2022-04-12': 5.91, '2022-04-14': 6.07, '2022-04-17': 6.63, '2022-04-19': 7.73, '2022-04-27': 6.28, '2022-04-29': 5.75, '2022-05-02': 6.28, '2022-05-04': 5.6, '2022-05-07': 6.51, '2022-05-12': 6.02, '2022-05-17': 6.22, '2022-05-19': 6.15, '2022-06-03': 5.57, '2022-06-06': 6.5, '2022-10-16': 5.74, '2022-10-24': 5.82, '2022-10-26': 5.68, '2022-10-29': 5.74, '2022-10-31': 5.68, '2022-11-03': 5.67, '2022-11-05': 5.69, '2022-11-08': 5.84, '2022-11-10': 5.65, '2022-11-13': 5.79, '2022-11-15': 5.71, '2022-11-18': 5.65, '2022-11-20': 5.66, '2022-11-23': 5.74, '2022-11-25': 5.81, '2022-11-28': 5.68, '2022-11-30': 5.52, '2022-12-03': 5.51, '2022-12-05': 6.53, '2022-12-10': 5.53, '2022-12-13': 7.26, '2022-12-18': 5.44, '2022-12-20': 5.47, '2022-12-23': 5.65, '2022-12-25': 5.47, '2022-12-28': 5.44, '2022-12-30': 5.52, '2023-01-02': 5.53, '2023-01-04': 5.82, '2023-01-07': 6.98, '2023-01-09': 5.54, '2023-01-12': 5.48, '2023-01-14': 5.54, '2023-01-17': 5.63, '2023-01-19': 5.46, '2023-01-22': 5.87, '2023-01-24': 5.58, '2023-01-27': 6.52, '2023-01-29': 5.53, '2023-02-01': 6.71, '2023-02-03': 5.6, '2023-02-06': 5.63, '2023-02-08': 5.46, '2023-02-11': 5.41, '2023-02-13': 5.38, '2023-02-16': 5.48, '2023-02-18': 5.35, '2023-02-21': 5.58, '2023-02-23': 5.38, '2023-02-26': 5.68, '2023-02-28': 6.0, '2023-03-03': 5.56, '2023-03-08': 6.01, '2023-03-10': 6.39, '2023-03-18': 5.96, '2023-03-25': 5.29, '2023-03-28': 6.07, '2023-03-30': 5.25, '2023-04-02': 6.22, '2023-04-04': 5.29, '2023-04-07': 6.26, '2023-04-09': 5.5, '2023-04-12': 6.13, '2023-04-17': 5.84, '2023-04-22': 7.33, '2023-05-09': 5.8, '2023-05-12': 6.82, '2023-05-14': 5.73, '2023-05-17': 6.66, '2023-05-19': 5.63, '2023-05-22': 6.82, '2023-05-24': 5.74, '2023-05-27': 6.09, '2023-05-29': 5.49, '2023-06-01': 6.55, '2023-06-08': 6.0, '2023-09-29': 9.04, '2023-10-01': 6.75, '2023-10-04': 6.08, '2023-10-06': 5.69, '2023-10-09': 5.91, '2023-10-11': 6.05, '2023-10-14': 19.86, '2023-10-19': 6.14, '2023-10-24': 5.69, '2023-10-26': 5.71, '2023-10-29': 5.7, '2023-10-31': 5.7, '2023-11-03': 5.75, '2023-11-05': 5.62, '2023-11-15': 5.3, '2023-11-18': 5.79, '2023-11-20': 5.67, '2023-11-23': 5.62, '2023-12-03': 5.65, '2023-12-08': 5.72, '2023-12-10': 5.61, '2023-12-15': 5.65, '2023-12-23': 5.48, '2023-12-25': 5.53, '2023-12-28': 5.57, '2023-12-30': 5.5, '2024-01-02': 5.75, '2024-01-04': 5.54, '2024-01-07': 6.34, '2024-01-09': 5.72, '2024-01-12': 5.58, '2024-01-14': 5.4, '2024-01-17': 5.46, '2024-01-19': 5.48, '2024-01-24': 5.48, '2024-01-27': 5.94, '2024-02-01': 5.39, '2024-02-03': 5.41, '2024-02-06': 5.55, '2024-02-08': 5.33, '2024-02-11': 5.54, '2024-02-16': 6.85, '2024-02-18': 5.47, '2024-02-21': 5.58, '2024-02-23': 5.31}}}



def cleaning(name, data):
    # Debug: Print the input data structure
    print("Input data structure:", data)

    # Check if the expected keys exist
    if name not in data:
        raise ValueError(f"Key '{name}' not found in the top level of the input data.")
    
    # Check if the second-level key exists
    if name not in data[name]:
        print(f"Warning: Key '{name}' not found in the second level of the input data. Using an empty dictionary.")
        data[name] = {name: {}}

    # Extract the nested dictionary containing the actual data
    data = data[name][name]

    # If data is empty, return an empty dictionary
    if not data:
        print("Warning: No data found for processing.")
        return {}

    # Convert the input dictionary to a DataFrame
    df = pd.DataFrame(list(data.items()), columns=['Date', name])

    # Ensure the 'Date' column is parsed as datetime and set as index
    df['Date'] = pd.to_datetime(df['Date'])
    df.set_index('Date', inplace=True)

    print("Original Data:")
    print(df.head())

    # Step 1: Remove negative values
    df_cleaned = df[df[name] >= 0]

    # Step 2: Calculate the threshold using IQR
    Q1 = df_cleaned[name].quantile(0.25)
    Q3 = df_cleaned[name].quantile(0.75)
    IQR = Q3 - Q1
    threshold = Q3 + 6.3 * IQR

    print(f"Threshold (Q3 + 6.3 * IQR): {threshold}")

    # Step 3: Remove values above the threshold
    df_cleaned = df_cleaned[df_cleaned[name] <= threshold]

    # Step 4: Smooth the data using a moving median
    df_cleaned[name + '_smoothed'] = df_cleaned[name].rolling(window=1, min_periods=1).median()

    # Step 5: Interpolate missing values
    df_cleaned[name + '_interpolated'] = df_cleaned[name + '_smoothed'].interpolate(method='linear')

    # Step 6: Convert cleaned DataFrame back to dictionary format
    filtered_dict = df_cleaned[name + '_interpolated'].to_dict()

    print("\nCleaned data returned as dictionary")
    print(filtered_dict)
    return filtered_dict


print(cleaning('DO',data))
